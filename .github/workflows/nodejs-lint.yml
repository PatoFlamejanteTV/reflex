name: Node.js Linting

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./server

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '20'
    cache: 'npm'
    cache-dependency-path: server/package-lock.json

- name: Verify lockfile exists
  run: test -f server/package-lock.json || (echo "package-lock.json not found" && exit 1)

- name: Install dependencies
  working-directory: server
  run: npm ci

- name: Auto-fix lint issues and commit
  working-directory: server
  run: |
    # Try to auto-fix lint issues (ESLint-style)
    npm run lint -- --fix || true

    # Commit changes if any
    if ! git diff --quiet; then
      git config user.name "github-actions[bot]"
      git config user.email "github-actions[bot]@users.noreply.github.com"
      git add .
      git commit -m "style: auto-fix eslint issues"
      git push
    fi